@page "/CloneSelectedItems"

@using Syncfusion.Blazor.Diagram
@using System.Collections.ObjectModel
@inject IJSRuntime js
@using Syncfusion.Blazor.Buttons

<SfButton Content="Clone" OnClick="@Clone" />
<SfDiagramComponent @ref="_diagram" Width="50%" Height="800px" @bind-Connectors="@_connectors" @bind-Nodes="_nodeCollection"></SfDiagramComponent>

@functions
{
    private double _offsetX = 0;
    private double _offsetY = 0;
    private double _opacity = 0;
    private string _id = "diagram";
    private SfDiagramComponent _diagram;
    private DiagramObjectCollection<Node> _nodeCollection = new DiagramObjectCollection<Node>();
    private DiagramObjectCollection<Connector> _connectors = new DiagramObjectCollection<Connector>();
    
    protected override void OnInitialized()
    {
        Node node1 = new Node()
        {
            ID = "node1",
            OffsetX = 100,
            OffsetY = 100,
            Height = 100,
            Width = 100,
            Annotations = new DiagramObjectCollection<ShapeAnnotation>()
            {
                new ShapeAnnotation()
                {
                    Content = "node1"
                },
            },
        };
        _nodeCollection.Add(node1);
        Node node2 = new Node()
        {
            ID = "node2",
            OffsetX = 100,
            OffsetY = 300,
            Height = 100,
            Width = 100,
            Annotations = new DiagramObjectCollection<ShapeAnnotation>()
            {
                new ShapeAnnotation()
                {
                    Content = "node2"
                },
            },
        };
        _nodeCollection.Add(node2);
        NodeGroup group1 = new NodeGroup()
        {
            ID = "group1",
            Children = new string[] { "node1", "node2" },
            Annotations = new DiagramObjectCollection<ShapeAnnotation>()
            {
                new ShapeAnnotation()
                {
                    Content = "Group1"
                }
            },
        };
        _nodeCollection.Add(group1);
        Node node3 = new Node()
        {
            ID = "node3",
            OffsetX = 300,
            OffsetY = 100,
            Height = 100,
            Width = 100,
            Annotations = new DiagramObjectCollection<ShapeAnnotation>()
            {
                new ShapeAnnotation()
                {
                    Content = "node3"
                },
            },
        };
        _nodeCollection.Add(node3);
        Connector connector = new Connector()
        {
            ID = "connector1",
            SourcePoint = new DiagramPoint() { X = 250, Y = 250 },
            TargetPoint = new DiagramPoint() { X = 350, Y = 350 },
        };
        _connectors.Add(connector);
        NodeGroup group2 = new NodeGroup()
        {
            ID = "group2",
            Children = new string[] { "node3", "connector1", "group1" },
            Annotations = new DiagramObjectCollection<ShapeAnnotation>()
            {
                new ShapeAnnotation()
                {
                    Content = "Group2"
                }
            },
        };
        _nodeCollection.Add(group2);
    }

    private void Clone()
    {
        _diagram.StartGroupAction();
        if (_diagram.SelectionSettings.Nodes.Count > 0)
        {
            NodeBase NodeObj = _diagram.SelectionSettings.Nodes[0] as NodeBase;
            if (NodeObj is NodeGroup gNode)
            {
                CloneGroup(gNode, false);
            }
            else if (NodeObj is Node node)
            {
                CloneNode(node, false);
            }
        }
        if (_diagram.SelectionSettings.Connectors.Count > 0)
        {
            NodeBase ConnectorObj = _diagram.SelectionSettings.Connectors[0] as NodeBase;
            if (ConnectorObj is Connector connectorObj)
            {
                CloneConnector(connectorObj, false);
            }
        }
        _diagram.ClearSelection();
        _diagram.EndGroupAction();
    }

    private string CloneGroup(NodeGroup gNode, bool isChild)
    {
        NodeGroup groupNode = gNode.Clone() as NodeGroup;
        groupNode.ID = RandomId();
        List<string> child = new List<string>();
        foreach (string childID in groupNode.Children)
        {
            for (int i = 0; i < diagram.Nodes.Count; i++)
            {
                if (childID == diagram.Nodes[i].ID && diagram.Nodes[i] is NodeGroup nodeGroup)
                {
                    child.Add(CloneGroup(nodeGroup, true));
                }
                else if (childID == diagram.Nodes[i].ID)
                {
                    child.Add(CloneNode(diagram.Nodes[i], true));
                }
            }
            for (int i = 0; i < diagram.Connectors.Count; i++)
            {
                if (childID == diagram.Connectors[i].ID)
                {
                    child.Add(CloneConnector(diagram.Connectors[i], true));
                }
            }
        }
        groupNode.Children = child.ToArray();
        if (!isChild)
        {
            groupNode.OffsetX += 25;
            groupNode.OffsetY += 25;
        }
         _ = _diagram.AddDiagramElementsAsync(new DiagramObjectCollection<NodeBase>() { groupNode });
        return groupNode.ID;
    }

    private string CloneNode(Node node, bool isChild)
    {
        _diagram.StartGroupAction();
        Node nodeChild = node.Clone() as Node;
        nodeChild.ID = RandomId();
        if (!isChild)
        {
            nodeChild.OffsetX += 25;
            nodeChild.OffsetY += 25;
        }
         _ = _diagram.AddDiagramElementsAsync(new DiagramObjectCollection<NodeBase>() { nodeChild });
        _diagram.EndGroupAction();
        return nodeChild.ID;
    }

    private string CloneConnector(Connector connector, bool isChild)
    {
        _diagram.StartGroupAction();
        Connector connectorChild = connector.Clone() as Connector;
        connectorChild.ID = RandomId();
        if (!isChild)
        {
            connectorChild.SourcePoint = new DiagramPoint() { X = connectorChild.SourcePoint.X + 25, Y = connectorChild.SourcePoint.Y + 25 };
            connectorChild.TargetPoint = new DiagramPoint() { X = connectorChild.TargetPoint.X + 25, Y = connectorChild.TargetPoint.Y + 25 };
        }
         _ = _diagram.AddDiagramElementsAsync(new DiagramObjectCollection<NodeBase>() { connectorChild });
        _diagram.EndGroupAction();
        return connectorChild.ID;
    }

    private string RandomId()
    {
        Random random = new Random();
        const string chars = "ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
#pragma warning disable CA5394 // Do not use insecure randomness
        return new string(Enumerable.Repeat(chars, 5)
          .Select(s => s[random.Next(s.Length)]).ToArray());
#pragma warning restore CA5394 // Do not use insecure randomness
    }
}