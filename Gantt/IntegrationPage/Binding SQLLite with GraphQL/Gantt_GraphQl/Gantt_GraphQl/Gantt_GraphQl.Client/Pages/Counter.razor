@page "/"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Http
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Data
@using Syncfusion.Blazor.Gantt
@using System.Text.Json.Serialization
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Nav

<SfGantt TValue="TaskData"
         Height="600px"
         AllowFiltering="true"
         AllowSorting="true"
         TreeColumnIndex="1"
         EnableContextMenu="true"
         Toolbar="@(new List<string>() { "Add", "Edit", "Delete", "Update", "Cancel", "Search" })">

    <SfDataManager Url="@GraphQlUrl"
                   Adaptor="Adaptors.GraphQLAdaptor"
                   GraphQLAdaptorOptions="@AdaptorOptions">
    </SfDataManager>

    <GanttTaskFields Id="@nameof(TaskData.TaskId)"
                     Name="@nameof(TaskData.TaskName)"
                     StartDate="@nameof(TaskData.StartDate)"
                     EndDate="@nameof(TaskData.EndDate)"
                     Duration="@nameof(TaskData.Duration)"
                     Progress="@nameof(TaskData.Progress)"
                     ParentID="@nameof(TaskData.ParentId)">
    </GanttTaskFields>

    <GanttEditSettings AllowAdding="true" AllowEditing="true" AllowDeleting="true" />

    <GanttColumns>
        <GanttColumn Field="@nameof(TaskData.TaskId)" HeaderText="Task ID" Width="150" IsPrimaryKey="true"></GanttColumn>
        <GanttColumn Field="@nameof(TaskData.TaskName)" HeaderText="Task Name" Width="250"></GanttColumn>
        <GanttColumn Field="@nameof(TaskData.StartDate)" HeaderText="Start Date" Format="d" Width="130"></GanttColumn>
        <GanttColumn Field="@nameof(TaskData.EndDate)" HeaderText="End Date" Format="d" Width="130"></GanttColumn>
        <GanttColumn Field="@nameof(TaskData.Duration)" HeaderText="Duration" Width="110"></GanttColumn>
        <GanttColumn Field="@nameof(TaskData.Progress)" HeaderText="Progress" Width="110"></GanttColumn>
    </GanttColumns>

</SfGantt>

@code {

    // Robust absolute URL creation for GraphQL endpoint
    private string GraphQlUrl
    {
        get
        {
            var ctx = HttpContextAccessor?.HttpContext;
            if (ctx != null)
            {
                // Build absolute URL using the current request's scheme/host
                return $"{ctx.Request.Scheme}://{ctx.Request.Host}{ctx.Request.PathBase}/graphql";
            }
            // fallback (client)
            return Nav.ToAbsoluteUri("graphql").ToString();
        }
    }

    private GraphQLAdaptorOptions AdaptorOptions => new GraphQLAdaptorOptions
    {
        // Must match the GraphQL field returned under "data" (case-sensitive).
        ResolverName = "taskData",

        // Must request "count" and "result" from the resolver. [1](https://github.com/jmbelmonte/BlazorServer-EFCore-SampleApp)
        Query = @"
query taskData($dataManager: DataRequest!) {
  taskData(dataManager: $dataManager) {
    count
    result {
      taskId
      taskName
      startDate
      endDate
      parentId
      duration
      progress
    }
  }
}",

        // Mutations must use the variable names expected by Syncfusion GraphQLMutation. [2](https://blazor.syncfusion.com/documentation/gantt-chart/data-binding)
        Mutation = new GraphQLMutation
        {
            Insert = @"
mutation insert($record: TaskInput!, $index: Int!, $action: String!, $additionalParameters: Any) {
  insertTask(record: $record, position: $index, action: $action, additionalParameters: $additionalParameters) {
    taskId
    taskName
    startDate
    endDate
    parentId
    duration
    progress
  }
}",

            Update = @"
mutation update($record: TaskInput!, $action: String!, $primaryColumnName: String!, $primaryColumnValue: Int!, $additionalParameters: Any) {
  updateTask(record: $record, action: $action, keyField: $primaryColumnName, keyValue: $primaryColumnValue, additionalParameters: $additionalParameters) {
    taskId
    taskName
    startDate
    endDate
    parentId
    duration
    progress
  }
}",

            Delete = @"
mutation delete($primaryColumnValue: Int!, $action: String!, $primaryColumnName: String!, $additionalParameters: Any) {
  deleteTask(id: $primaryColumnValue, action: $action, keyField: $primaryColumnName, additionalParameters: $additionalParameters) {
    taskId
  }
}"
        }
    };

    // Client-side model: property names match Gantt field mapping,
    // JsonPropertyName matches GraphQL field names in the response.
    public class TaskData
    {
        [JsonPropertyName("taskId")]
        public int? TaskId { get; set; }

        [JsonPropertyName("taskName")]
        public string? TaskName { get; set; }

        [JsonPropertyName("startDate")]
        public DateTime? StartDate { get; set; }

        [JsonPropertyName("endDate")]
        public DateTime? EndDate { get; set; }

        [JsonPropertyName("parentId")]
        public int? ParentId { get; set; }

        [JsonPropertyName("duration")]
        public int? Duration { get; set; }

        [JsonPropertyName("progress")]
        public int Progress { get; set; }
    }
}